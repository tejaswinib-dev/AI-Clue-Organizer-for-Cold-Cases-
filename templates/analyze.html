<!DOCTYPE html>
<html lang="en">
<head><style>
/* chat container */
.chat-wrapper {
  display: flex;
  gap: 20px;
  align-items: flex-start;
  margin-top: 20px;
}

/* left: chat */
.chat-panel {
  width: 38%;
  min-width: 320px;
  background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.25);
}

/* right: graph */
.graph-panel {
  flex: 1;
  background: rgba(255,255,255,0.02);
  border-radius: 12px;
  padding: 14px;
  text-align: center;
  box-shadow: 0 6px 18px rgba(0,0,0,0.12);
}

/* chat list */
.chat-list {
  height: 420px;
  overflow-y: auto;
  padding: 10px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

/* message bubbles */
.bubble {
  display: inline-block;
  padding: 10px 14px;
  border-radius: 18px;
  max-width: 85%;
  line-height: 1.3;
  font-size: 0.95rem;
  box-shadow: 0 4px 10px rgba(0,0,0,0.12);
}

/* user (right) */
.bubble.user {
  
  background: linear-gradient(135deg, #6EE7B7, #3B82F6);
  color: #04212b;
  border-bottom-right-radius: 4px;
}

/* assistant (left) */
.bubble.assistant {
  margin-right: auto;
  background: linear-gradient(135deg, #ffffff, #f1f5f9);
  color: #111827;
  border-bottom-left-radius: 4px;
}

/* gradient animated typing bubble */
.typing {
  width: 60px;
  height: 18px;
  border-radius: 10px;
  background: linear-gradient(90deg, #7c3aed, #06b6d4, #10b981);
  background-size: 200% 200%;
  animation: gradientShift 2.2s linear infinite;
  box-shadow: 0 6px 14px rgba(12, 12, 12, 0.12);
}
@keyframes gradientShift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

.chat-controls {
  display: flex;
  gap: 8px;
  margin-top: 12px;
}
.chat-controls input[type="text"]{
  flex:1;
  padding:10px 12px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.06);
  background: rgba(255,255,255,0.02);
  color: #f8fafc;
}
.chat-controls button {
  padding:10px 14px;
  border-radius:10px;
  background:#0ea5e9;
  color:#fff;
  border: none;
}

.small-toggle {
  margin-top:8px;
  display:flex;
  align-items:center;
  gap:8px;
  font-size:0.9rem;
  color:#cbd5e1;
}

</style>
<meta charset="UTF-8">
<title>Analyze Case</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container-fluid">
    <h2><a class="navbar-brand" href="#">AI Clue Organizer</a></h2>
    <ul class="navbar-nav ms-auto">
      <strong><li class="nav-item"><a class="nav-link" href="{{ url_for('dashboard') }}">Home</a></li></strong>
      <strong><li class="nav-item"><a class="nav-link" href="{{ url_for('search') }}">Search</a></li></strong>
      <strong><li class="nav-item"><a class="nav-link" href="{{ url_for('cases') }}">Cases</a></li></strong>
      <strong><li class="nav-item"><a class="nav-link" href="{{ url_for('analyze') }}">Analyze Case</a></li></strong>
      <strong><li class="nav-item"><a class="nav-link" href="{{ url_for('visualization') }}">Visualization</a></li></strong>
      <strong><li class="nav-item"><a class="nav-link" href="{{ url_for('logout') }}">Logout</a></li></strong>
    </ul>
  </div>
</nav>
<div class="container mt-4">
<h2 style="color:#ced4da">Analyze Case Description</h2>
<form method="POST">
  <div class="mb-3">
    <textarea name="description" class="form-control" placeholder="Enter case description..." rows="4" required></textarea>
  </div>
  <button type="submit" class="btn btn-primary">Analyze</button>
</form>

{% if suspect %}
<div class="mt-4">
  <h5 style="color:#ced4da">Predicted Suspect: <strong>{{ suspect }}</strong></h5>
</div>
{% endif %}

{% if network_graph_html %}
<div class="mt-4">
  <h5 style="color:#ced4da" >Case Network Graph:</h5>
  <img src="data:image/png;base64,{{ network_graph_html }}" class="img-fluid shadow">
</div>
{% endif %}
</div>
<!-- Chat & Graph Panel (paste into analyze.html) -->

<!--
<div class="chat-wrapper">
 
  <div class="chat-panel">
    <h4 style="margin:0 0 8px 0">Suspect Assistant</h4>
    <div style="font-size:0.9rem; color:#9ca3af; margin-bottom:8px;">
      Ask about: <strong id="suspect-name">{{ suspect or "Unknown" }}</strong>
    </div>

    <div id="chatList" class="chat-list">
    
      <div class="bubble assistant">
        Hi â€” I can answer questions about the predicted suspect using case records only. Try:
        <ul style="margin:8px 0 0 18px; font-size:0.9rem; color:#374151">
          <li>When did the reported incidents occur?</li>
          <li>What weapon was used most often?</li>
          <li>What is the latest case summary?</li>
        </ul>
      </div>
    </div>

    <div class="small-toggle">
      <label style="display:flex;gap:6px;align-items:center">
        <input id="useLlm" type="checkbox" /> Use LLM paraphrase (optional)
      </label>
    </div>

    <div class="chat-controls">
      <input id="chatInput" type="text" placeholder="Ask a question about the suspect..." />
      <button id="sendBtn">Ask</button>
    </div>
  </div>

  
   <div class="graph-panel">
    <h4 style="margin-top:0">Related Cases Graph</h4>
    <div style="margin:10px 0">
      {% if network_graph_html %}
        <!--network image provided by backend (base64 PNG
        <img src="data:image/png;base64,{{ network_graph_html }}" alt="network-graph" style="max-width:100%; border-radius:8px;"/>
      {% else %}
        <div style="padding:40px; color:#9ca3af">No related-case graph available for this suspect.</div>
      {% endif %}
    </div>
  </div>
</div>

<script>
async function sendMessage(){
   const message=documument.getElementById("userInput").value.trim();
   if(!message) return;

   const response=await fetch("/chatbot",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message})});

   if(!response.ok){
    const text=await response.text();
    console.error("Server error",text);
    addMessage("server returned an error","bot");
    return;
  }
  const data=await response.json().catch(err=>{
    console.error("JSON parse error",err);
  addMessage("inavlid JSON from server","bot");
  });
  if(data && data.reply){
    addMessage(data.reply,"bot");
  }
}
function addMessage(text,sender){
  const chatbox=document.getElementById("chatbox");
  const messageDiv=document.createElement("div");
  messageDiv.classList.add(sender);
  messageDiv.textContent=text;
  chatbox.appendChild(messageDiv);
  chatbox.scrollTop=chatbox.scrollHeight;
}
</script>-->
<!-- Chatbot Section -->
<div class="chatbox" id="chatbox"></div>
<div class="chat-input">
  <input type="text" id="userInput" placeholder="Ask about the suspect or case..." />
  <button onclick="sendMessage()">Ask</button>
</div>

<style>
.chatbox {
  background: rgba(255,255,255,0.1);
  border-radius: 15px;
  padding: 15px;
  height: 400px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}
.message {
  margin: 8px 0;
  padding: 10px 15px;
  border-radius: 18px;
  max-width: 70%;
  animation: fadeIn 0.4s ease;
}
.user {
  align-self: flex-end;
  background: linear-gradient(135deg, #00c6ff, #0072ff);
  color: #fff;
}
.bot {
  align-self: flex-start;
  background: linear-gradient(135deg, #43e97b, #38f9d7);
  color: #000;
}
.chat-input {
  display: flex;
  margin-top: 10px;
}
.chat-input input {
  flex: 1;
  padding: 10px;
  border-radius: 10px;
  border: none;
}
.chat-input button {
  margin-left: 10px;
  background: #00bcd4;
  color: white;
  border: none;
  border-radius: 10px;
  padding: 10px 16px;
  cursor: pointer;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

<script>
async function sendMessage() {
  const input = document.getElementById("userInput");
  const chatbox = document.getElementById("chatbox");
  const userText = input.value.trim();
  if (!userText) return;

  // Display user message (right)
  chatbox.innerHTML += `<div class="message user">${userText}</div>`;
  input.value = "";

  // Send to backend
  const res = await fetch("/chatbot", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ message: userText })
  });
  const data = await res.json();

  // Display bot reply (left)
  chatbox.innerHTML += `<div class="message bot">${data.response}</div>`;
  chatbox.scrollTop = chatbox.scrollHeight;
}
</script>
<!-- Analytics Graph Section -->
<h3 style="color:#ced4da">Chatbot Response Analytics</h3>
<canvas id="analyticsChart" width="600" height="400"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Arrays to store analytics data
    let responseTimes = [];
    let answerWeights = [];
    let labels = [];

    // Initialize Chart.js
    const ctx = document.getElementById('analyticsChart').getContext('2d');
    const analyticsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Response Time (s)',
                    data: responseTimes,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor:'rgba(54,162,235,0.2)',
                    tension:0.3,
                   

                },
                {
                    label: 'Answer Weight',
                    data: answerWeights,
                    backgroundColor: 'rgba(255, 206, 86, 0.2)',
                    borderColor:'rgba(255,206,86,1)',
                    tension:0.3,
                   
                }
            ]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
        }
    });

    // Modify your existing sendMessage() function to update the chart
    const originalSendMessage = sendMessage;
    sendMessage = async function() {
        const input = document.getElementById("userInput");
        const chatbox = document.getElementById("chatbox");
        const userText = input.value.trim();
        if (!userText) return;

        // Display user message
        chatbox.innerHTML += `<div class="message user">${userText}</div>`;
        input.value = "";

        // Send to backend
        const res = await fetch("/chatbot", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: userText })
        });
        const data = await res.json();

        // Display bot reply
        chatbox.innerHTML += `<div class="message bot">${data.response}</div>`;
        chatbox.scrollTop = chatbox.scrollHeight;

        // Add analytics data
        labels.push(`Query ${labels.length + 1}`);
        responseTimes.push(data.response_time_seconds || 0);
        answerWeights.push(data.answer_weight || 0);
        analyticsChart.update();
    }
</script>



</body>
</html>
